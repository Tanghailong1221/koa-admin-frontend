# KOA 后台管理系统 API 接口文档

## 基础信息

- **基础路径**: `http://localhost:3000/api`
- **认证方式**: Bearer Token (JWT)
- **请求头**: `Authorization: Bearer <token>`

## 通用响应格式

```json
{
  "code": 0,        // 0-成功，其他-失败
  "message": "success",
  "data": {}        // 响应数据
}
```

---

## 一、用户模块 `/api/user`

### 1.1 用户登录
- **接口**: `POST /api/user/login`
- **认证**: 无需认证
- **请求参数**:
```json
{
  "username": "admin",    // 必填，用户名
  "password": "123456"    // 必填，密码
}
```
- **响应**:
```json
{
  "code": 0,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "...",
    "userInfo": {
      "id": 1,
      "username": "admin",
      "roleId": 1
    }
  }
}
```

### 1.2 获取当前用户信息
- **接口**: `GET /api/user/current`
- **认证**: 需要认证
- **请求参数**: 无
- **响应**: 当前登录用户的详细信息

### 1.3 获取用户列表
- **接口**: `GET /api/user/list`
- **认证**: 需要认证
- **权限**: `user:list`
- **请求参数** (Query):
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| page | number | 否 | 页码，默认1 |
| size | number | 否 | 每页条数，默认10 |
| keyword | string | 否 | 关键词搜索（用户名） |
| status | number | 否 | 状态（1-启用，0-禁用） |

### 1.4 获取用户详情
- **接口**: `GET /api/user/:id`
- **认证**: 需要认证
- **权限**: `user:detail`
- **路径参数**: `id` - 用户ID

### 1.5 创建用户
- **接口**: `POST /api/user`
- **认证**: 需要认证
- **权限**: `user:create`
- **请求参数**:
```json
{
  "username": "testuser",   // 必填，用户名
  "password": "123456",     // 必填，密码
  "nickname": "测试用户",    // 可选，昵称
  "roleId": 1,              // 必填，角色ID
  "status": 1,              // 可选，状态（1-启用，0-禁用）
  "orgId": 1,               // 可选，机构ID
  "positionId": 1,          // 可选，职位ID
  "avatar": "",             // 可选，头像URL
  "phone": "13800138000",   // 可选，联系电话
  "email": "test@test.com", // 可选，邮箱
  "gender": 1,              // 可选，性别（0未知 1男 2女）
  "birthday": "1990-01-01", // 可选，出生年月
  "remark": "备注信息"       // 可选，备注
}
```

### 1.6 更新用户
- **接口**: `PUT /api/user/:id`
- **认证**: 需要认证
- **权限**: `user:update`
- **路径参数**: `id` - 用户ID
- **请求参数**: 同创建用户（所有字段可选）

### 1.7 删除用户
- **接口**: `DELETE /api/user/:id`
- **认证**: 需要认证
- **权限**: `user:delete`
- **路径参数**: `id` - 用户ID

### 1.8 修改用户状态
- **接口**: `PUT /api/user/:id/status`
- **认证**: 需要认证
- **权限**: `user:update`
- **请求参数**:
```json
{
  "status": 1  // 必填，状态（1-启用，0-禁用）
}
```

### 1.9 修改密码
- **接口**: `POST /api/user/change-password`
- **认证**: 需要认证
- **请求参数**:
```json
{
  "oldPassword": "123456",  // 必填，旧密码
  "newPassword": "654321"   // 必填，新密码
}
```

### 1.10 刷新Token
- **接口**: `POST /api/user/refresh-token`
- **认证**: 无需认证
- **请求参数**:
```json
{
  "refreshToken": "..."  // 必填，刷新令牌
}
```

### 1.11 退出登录
- **接口**: `POST /api/user/logout`
- **认证**: 需要认证
- **请求参数**:
```json
{
  "refreshToken": "..."  // 可选，同时作废refreshToken
}
```

---

## 二、角色管理 `/api/role`

### 2.1 获取角色列表
- **接口**: `GET /api/role/list`
- **认证**: 需要认证
- **权限**: `role:list`
- **请求参数** (Query):
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| page | number | 否 | 页码，默认1 |
| size | number | 否 | 每页条数，默认10 |
| keyword | string | 否 | 关键词搜索（角色名称或编码） |

### 2.2 获取角色详情
- **接口**: `GET /api/role/:id`
- **认证**: 需要认证
- **权限**: `role:detail`
- **路径参数**: `id` - 角色ID

### 2.3 创建角色
- **接口**: `POST /api/role`
- **认证**: 需要认证
- **权限**: `role:create`
- **请求参数**:
```json
{
  "roleName": "普通用户",     // 必填，角色名称
  "roleCode": "user",        // 必填，角色编码
  "description": "普通用户角色", // 可选，角色描述
  "status": 1,               // 可选，状态（1-启用，0-禁用），默认1
  "sort": 0,                 // 可选，排序，默认0
  "permissionIds": [1, 2, 3]  // 可选，权限ID数组
}
```

### 2.4 更新角色
- **接口**: `PUT /api/role/:id`
- **认证**: 需要认证
- **权限**: `role:update`
- **路径参数**: `id` - 角色ID
- **请求参数**: 同创建角色（所有字段可选）

### 2.5 删除角色
- **接口**: `DELETE /api/role/:id`
- **认证**: 需要认证
- **权限**: `role:delete`
- **路径参数**: `id` - 角色ID

### 2.6 分配权限
- **接口**: `POST /api/role/:id/permissions`
- **认证**: 需要认证
- **权限**: `role:assign`
- **路径参数**: `id` - 角色ID
- **请求参数**:
```json
{
  "permissionIds": [1, 2, 3, 4, 5]  // 必填，权限ID数组
}
```

---

## 三、菜单管理 `/api/menu`

### 3.1 获取菜单树（全部）
- **接口**: `GET /api/menu/tree`
- **认证**: 需要认证
- **权限**: `menu:list`
- **请求参数** (Query):
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| status | number | 否 | 状态过滤（1启用 0禁用） |

### 3.2 获取当前角色菜单树
- **接口**: `GET /api/menu/tree/current`
- **认证**: 需要认证
- **请求参数**: 无
- **说明**: 返回当前登录用户角色对应的菜单树

### 3.3 获取菜单列表
- **接口**: `GET /api/menu/list`
- **认证**: 需要认证
- **权限**: `menu:list`
- **请求参数** (Query):
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| page | number | 否 | 页码，默认1 |
| size | number | 否 | 每页条数，默认10 |
| keyword | string | 否 | 关键词（名称/编码） |
| status | number | 否 | 状态（1启用 0禁用） |

### 3.4 获取菜单详情
- **接口**: `GET /api/menu/:id`
- **认证**: 需要认证
- **权限**: `menu:detail`
- **路径参数**: `id` - 菜单ID

### 3.5 创建菜单
- **接口**: `POST /api/menu`
- **认证**: 需要认证
- **权限**: `menu:create`
- **请求参数**:
```json
{
  "permName": "用户管理",        // 必填，菜单名称
  "permCode": "menu:system:user", // 必填，菜单编码（唯一）
  "path": "/system/user",        // 必填，前端路由路径
  "parentId": 0,                 // 可选，父级ID
  "component": "system/user",    // 可选，前端组件
  "icon": "user",                // 可选，图标
  "sort": 1,                     // 可选，排序
  "visible": 1,                  // 可选，1显示 0隐藏
  "status": 1                    // 可选，1启用 0禁用
}
```

### 3.6 更新菜单
- **接口**: `PUT /api/menu/:id`
- **认证**: 需要认证
- **权限**: `menu:update`
- **路径参数**: `id` - 菜单ID
- **请求参数**: 同创建菜单（所有字段可选）

### 3.7 删除菜单
- **接口**: `DELETE /api/menu/:id`
- **认证**: 需要认证
- **权限**: `menu:delete`
- **路径参数**: `id` - 菜单ID

---

## 四、权限管理 `/api/permission`

### 4.1 获取权限树
- **接口**: `GET /api/permission/tree`
- **认证**: 需要认证
- **权限**: `permission:list`
- **请求参数**: 无

### 4.2 获取所有权限（不分页）
- **接口**: `GET /api/permission/all`
- **认证**: 需要认证
- **权限**: `permission:list`
- **请求参数**: 无

### 4.3 获取权限列表
- **接口**: `GET /api/permission/list`
- **认证**: 需要认证
- **权限**: `permission:list`
- **请求参数** (Query):
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| page | number | 否 | 页码，默认1 |
| size | number | 否 | 每页条数，默认10 |
| keyword | string | 否 | 关键词搜索 |
| permType | number | 否 | 权限类型（1-菜单，2-按钮，3-接口） |
| parentId | number | 否 | 父权限ID |

### 4.4 获取权限详情
- **接口**: `GET /api/permission/:id`
- **认证**: 需要认证
- **权限**: `permission:detail`
- **路径参数**: `id` - 权限ID

### 4.5 创建权限
- **接口**: `POST /api/permission`
- **认证**: 需要认证
- **权限**: `permission:create`
- **请求参数**:
```json
{
  "permName": "用户管理",   // 必填，权限名称
  "permCode": "user:manage", // 必填，权限编码
  "permType": 3,            // 必填，权限类型（1-菜单，2-按钮，3-接口）
  "parentId": 0,            // 可选，父权限ID，默认0
  "path": "/system/user",   // 可选，路由路径（菜单类型时使用）
  "component": "system/user", // 可选，组件路径（菜单类型时使用）
  "icon": "user",           // 可选，图标
  "sort": 0,                // 可选，排序，默认0
  "visible": 1,             // 可选，是否可见（1-是，0-否），默认1
  "remark": "备注信息"       // 可选，备注
}
```

### 4.6 更新权限
- **接口**: `PUT /api/permission/:id`
- **认证**: 需要认证
- **权限**: `permission:update`
- **路径参数**: `id` - 权限ID
- **请求参数**: 同创建权限（所有字段可选）

### 4.7 删除权限
- **接口**: `DELETE /api/permission/:id`
- **认证**: 需要认证
- **权限**: `permission:delete`
- **路径参数**: `id` - 权限ID

---

## 五、数据字典 `/api/dict`

### 5.1 根据类型获取字典列表
- **接口**: `GET /api/dict/type/:type`
- **认证**: 需要认证
- **路径参数**: `type` - 字典类型

### 5.2 获取字典列表
- **接口**: `GET /api/dict/list`
- **认证**: 需要认证
- **权限**: `dict:list`
- **请求参数** (Query):
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| page | number | 否 | 页码，默认1 |
| size | number | 否 | 每页条数，默认10 |
| dictType | string | 否 | 字典类型（模糊查询） |
| status | number | 否 | 状态（1-启用，0-禁用） |

### 5.3 获取字典详情
- **接口**: `GET /api/dict/:id`
- **认证**: 需要认证
- **权限**: `dict:detail`
- **路径参数**: `id` - 字典ID

### 5.4 创建字典
- **接口**: `POST /api/dict`
- **认证**: 需要认证
- **权限**: `dict:create`
- **请求参数**:
```json
{
  "dictType": "gender",    // 必填，字典类型
  "dictCode": "male",      // 必填，字典编码
  "dictValue": "1",        // 必填，字典值
  "dictLabel": "男",       // 必填，字典标签
  "sort": 1,               // 可选，排序
  "status": 1              // 可选，状态（1-启用，0-禁用）
}
```

### 5.5 更新字典
- **接口**: `PUT /api/dict/:id`
- **认证**: 需要认证
- **权限**: `dict:update`
- **路径参数**: `id` - 字典ID
- **请求参数**: 同创建字典（所有字段可选）

### 5.6 删除字典
- **接口**: `DELETE /api/dict/:id`
- **认证**: 需要认证
- **权限**: `dict:delete`
- **路径参数**: `id` - 字典ID

---

## 六、机构管理 `/api/org`

### 6.1 获取机构树
- **接口**: `GET /api/org/tree`
- **认证**: 需要认证
- **权限**: `org:list`
- **请求参数** (Query):
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| status | number | 否 | 状态过滤 |

### 6.2 获取机构列表
- **接口**: `GET /api/org/list`
- **认证**: 需要认证
- **权限**: `org:list`
- **请求参数** (Query):
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| page | number | 否 | 页码，默认1 |
| size | number | 否 | 每页条数，默认10 |
| keyword | string | 否 | 关键词搜索 |
| status | number | 否 | 状态 |

### 6.3 获取机构详情
- **接口**: `GET /api/org/:id`
- **认证**: 需要认证
- **权限**: `org:detail`
- **路径参数**: `id` - 机构ID

### 6.4 获取机构下的职位列表
- **接口**: `GET /api/org/:id/positions`
- **认证**: 需要认证
- **权限**: `org:list`
- **路径参数**: `id` - 机构ID

### 6.5 创建机构
- **接口**: `POST /api/org`
- **认证**: 需要认证
- **权限**: `org:create`
- **请求参数**:
```json
{
  "orgName": "技术部",    // 必填，机构名称
  "orgCode": "tech",     // 必填，机构编码
  "parentId": 0,         // 可选，父级ID，默认0
  "sort": 0,             // 可选，排序，默认0
  "status": 1,           // 可选，状态（1-启用，0-禁用），默认1
  "leader": "张三",       // 可选，负责人
  "phone": "13800138000", // 可选，联系电话
  "email": "tech@example.com", // 可选，邮箱
  "remark": "技术部门"    // 可选，备注
}
```

### 6.6 更新机构
- **接口**: `PUT /api/org/:id`
- **认证**: 需要认证
- **权限**: `org:update`
- **路径参数**: `id` - 机构ID
- **请求参数**: 同创建机构（所有字段可选）

### 6.7 删除机构
- **接口**: `DELETE /api/org/:id`
- **认证**: 需要认证
- **权限**: `org:delete`
- **路径参数**: `id` - 机构ID

---

## 七、职位管理 `/api/position`

### 7.1 获取职位列表
- **接口**: `GET /api/position/list`
- **认证**: 需要认证
- **权限**: `position:list`
- **请求参数** (Query):
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| page | number | 否 | 页码，默认1 |
| size | number | 否 | 每页条数，默认10 |
| keyword | string | 否 | 关键词搜索 |
| status | number | 否 | 状态 |
| orgId | number | 否 | 机构ID |

### 7.2 获取职位详情
- **接口**: `GET /api/position/:id`
- **认证**: 需要认证
- **权限**: `position:detail`
- **路径参数**: `id` - 职位ID

### 7.3 创建职位
- **接口**: `POST /api/position`
- **认证**: 需要认证
- **权限**: `position:create`
- **请求参数**:
```json
{
  "positionName": "前端工程师",  // 必填，职位名称
  "positionCode": "fe",         // 必填，职位编码
  "orgId": 1,                   // 必填，机构ID
  "sort": 0,                    // 可选，排序，默认0
  "status": 1,                  // 可选，状态（1-启用，0-禁用），默认1
  "remark": "负责前端开发工作"   // 可选，备注
}
```

### 7.4 更新职位
- **接口**: `PUT /api/position/:id`
- **认证**: 需要认证
- **权限**: `position:update`
- **路径参数**: `id` - 职位ID
- **请求参数**: 同创建职位（所有字段可选）

### 7.5 删除职位
- **接口**: `DELETE /api/position/:id`
- **认证**: 需要认证
- **权限**: `position:delete`
- **路径参数**: `id` - 职位ID

---

## 八、文件管理 `/api/upload`

### 8.1 单文件上传
- **接口**: `POST /api/upload/single`
- **认证**: 需要认证
- **请求类型**: `multipart/form-data`
- **请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| file | file | 是 | 上传的文件 |
- **响应**:
```json
{
  "code": 0,
  "message": "上传成功",
  "data": {
    "url": "/upload/1234567890-abc123.jpg",
    "filename": "image.jpg",
    "size": 102400,
    "md5": "abc123...",
    "mime": "image/jpeg"
  }
}
```

### 8.2 多文件上传
- **接口**: `POST /api/upload/multiple`
- **认证**: 需要认证
- **请求类型**: `multipart/form-data`
- **请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| files | file[] | 是 | 上传的文件列表（最多10个） |
- **响应**:
```json
{
  "code": 0,
  "message": "上传成功",
  "data": {
    "files": [
      {
        "url": "/upload/xxx.jpg",
        "filename": "image1.jpg",
        "size": 102400,
        "md5": "...",
        "mime": "image/jpeg"
      }
    ]
  }
}
```

---

## 九、数据导入导出 `/api/export`

### 9.1 导出用户数据
- **接口**: `GET /api/export/users`
- **认证**: 需要认证
- **权限**: `export:user`
- **请求参数** (Query):
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| keyword | string | 否 | 关键词搜索 |
| status | number | 否 | 状态过滤 |
- **响应**: Excel文件流

### 9.2 批量导出用户数据（大数据量）
- **接口**: `GET /api/export/users/large`
- **认证**: 需要认证
- **权限**: `export:user`
- **请求参数**: 同上
- **响应**: Excel文件流

### 9.3 导出角色数据
- **接口**: `GET /api/export/roles`
- **认证**: 需要认证
- **权限**: `export:role`
- **请求参数** (Query):
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| keyword | string | 否 | 关键词搜索 |
- **响应**: Excel文件流

### 9.4 导入用户数据
- **接口**: `POST /api/export/users/import`
- **认证**: 需要认证
- **权限**: `import:user`
- **请求类型**: `multipart/form-data`
- **请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| file | file | 是 | Excel文件 |
- **响应**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "summary": {
      "total": 100,
      "valid": 95,
      "invalid": 5,
      "success": 90,
      "failed": 10
    },
    "validationErrors": [],
    "importErrors": []
  }
}
```

### 9.5 导入角色数据
- **接口**: `POST /api/export/roles/import`
- **认证**: 需要认证
- **权限**: `import:role`
- **请求类型**: `multipart/form-data`
- **请求参数**: 同上

### 9.6 下载导入模板
- **接口**: `GET /api/export/template/:type`
- **认证**: 需要认证
- **路径参数**: `type` - 模板类型（user/role）
- **响应**: Excel模板文件流

---

## 十、日志管理 `/api/log`

### 10.1 获取操作日志列表
- **接口**: `GET /api/log/operation/list`
- **认证**: 需要认证
- **权限**: `log:list`
- **请求参数** (Query):
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| page | number | 否 | 页码 |
| pageSize | number | 否 | 每页数量 |
| username | string | 否 | 用户名 |
| operation | string | 否 | 操作类型 |
| method | string | 否 | 请求方法 |
| startTime | string | 否 | 开始时间 |
| endTime | string | 否 | 结束时间 |

- **响应字段说明**:
| 字段 | 类型 | 说明 |
|------|------|------|
| userId | number | 用户ID |
| username | string | 用户名 |
| operation | string | 操作URL |
| method | string | 请求方法 |
| url | string | 请求URL |
| ip | string | IP地址 |
| params | string | 请求参数（JSON字符串） |
| result | string | 操作结果 |
| duration | number | 耗时（毫秒） |
| userAgent | string | User-Agent信息 |
| errorMsg | string | 错误信息（失败时） |
| status | number | 状态（1-成功，0-失败） |
| createTime | datetime | 创建时间 |

### 10.2 获取操作日志详情
- **接口**: `GET /api/log/operation/:id`
- **认证**: 需要认证
- **权限**: `log:list`
- **路径参数**: `id` - 日志ID

### 10.3 导出操作日志
- **接口**: `GET /api/log/operation/export`
- **认证**: 需要认证
- **权限**: `log:export`
- **请求参数**: 同获取操作日志列表
- **响应**: Excel文件流

### 10.4 获取登录日志列表
- **接口**: `GET /api/log/login/list`
- **认证**: 需要认证
- **权限**: `log:list`
- **请求参数** (Query):
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| page | number | 否 | 页码 |
| pageSize | number | 否 | 每页数量 |
| username | string | 否 | 用户名 |
| status | number | 否 | 登录状态（0-失败, 1-成功） |
| startTime | string | 否 | 开始时间 |
| endTime | string | 否 | 结束时间 |

- **响应字段说明**:
| 字段 | 类型 | 说明 |
|------|------|------|
| userId | number | 用户ID |
| username | string | 用户名 |
| ip | string | 登录IP |
| location | string | 登录位置（根据IP解析） |
| browser | string | 浏览器信息 |
| os | string | 操作系统信息 |
| userAgent | string | User-Agent完整信息 |
| status | number | 登录状态（0-失败，1-成功） |
| message | string | 登录消息/失败原因 |
| loginTime | datetime | 登录时间 |

### 10.5 导出登录日志
- **接口**: `GET /api/log/login/export`
- **认证**: 需要认证
- **权限**: `log:export`
- **请求参数**: 同获取登录日志列表
- **响应**: Excel文件流

---

## 十一、定时任务管理 `/api/job`

### 11.1 获取任务列表
- **接口**: `GET /api/job/list`
- **认证**: 需要认证
- **权限**: `job:list`
- **请求参数**: 无
- **响应**:
```json
{
  "code": 0,
  "data": [
    {
      "name": "cleanLogs",
      "schedule": "0 0 * * *",
      "description": "清理日志",
      "status": "scheduled",
      "lastRunTime": "2024-01-01T00:00:00.000Z",
      "nextRunTime": "2024-01-02T00:00:00.000Z",
      "lastRunStatus": "success",
      "runCount": 10,
      "successCount": 10,
      "failedCount": 0
    }
  ]
}
```

### 11.2 获取任务详情
- **接口**: `GET /api/job/detail/:name`
- **认证**: 需要认证
- **权限**: `job:list`
- **路径参数**: `name` - 任务名称

### 11.3 启动指定任务
- **接口**: `POST /api/job/start/:name`
- **认证**: 需要认证
- **权限**: `job:start`
- **路径参数**: `name` - 任务名称

### 11.4 停止指定任务
- **接口**: `POST /api/job/stop/:name`
- **认证**: 需要认证
- **权限**: `job:stop`
- **路径参数**: `name` - 任务名称

### 11.5 启动所有任务
- **接口**: `POST /api/job/start-all`
- **认证**: 需要认证
- **权限**: `job:start`

### 11.6 停止所有任务
- **接口**: `POST /api/job/stop-all`
- **认证**: 需要认证
- **权限**: `job:stop`

---

## 十二、系统监控 `/api/monitor`

### 12.1 获取监控指标
- **接口**: `GET /api/monitor/metrics`
- **认证**: 需要认证
- **权限**: `monitor:metrics`
- **请求参数**: 无
- **响应**: 系统监控指标数据

### 12.2 健康检查
- **接口**: `GET /api/monitor/health`
- **认证**: 无需认证
- **请求参数**: 无
- **响应**:
```json
{
  "status": "ok",
  "timestamp": "2024-01-01T00:00:00.000Z",
  "services": {
    "database": { "status": "ok", "type": "MySQL" },
    "redis": { "status": "ok", "type": "Redis" }
  },
  "uptime": 3600,
  "memory": {
    "heapUsedPercent": 45,
    "status": "ok"
  }
}
```

### 12.3 重置监控指标
- **接口**: `POST /api/monitor/metrics/reset`
- **认证**: 需要认证
- **权限**: `monitor:metrics`

---

## 十三、WebSocket管理 `/api/websocket`

### 13.1 获取在线用户列表
- **接口**: `GET /api/websocket/online-users`
- **认证**: 需要认证
- **权限**: `websocket:list`
- **响应**:
```json
{
  "code": 200,
  "data": {
    "users": [
      { "userId": 1, "username": "admin", "connectedAt": "..." }
    ],
    "total": 1
  }
}
```

### 13.2 获取在线用户数量
- **接口**: `GET /api/websocket/online-count`
- **认证**: 需要认证
- **响应**:
```json
{
  "code": 200,
  "data": { "count": 10 }
}
```

### 13.3 检查用户是否在线
- **接口**: `GET /api/websocket/user/:userId/online`
- **认证**: 需要认证
- **路径参数**: `userId` - 用户ID
- **响应**:
```json
{
  "code": 200,
  "data": { "userId": 1, "isOnline": true }
}
```

### 13.4 向指定用户发送消息
- **接口**: `POST /api/websocket/user/:userId/send`
- **认证**: 需要认证
- **权限**: `websocket:send`
- **路径参数**: `userId` - 用户ID
- **请求参数**:
```json
{
  "event": "notification",  // 必填，事件名称
  "data": { ... }           // 可选，消息数据
}
```

### 13.5 广播消息
- **接口**: `POST /api/websocket/broadcast`
- **认证**: 需要认证
- **权限**: `websocket:broadcast`
- **请求参数**:
```json
{
  "event": "announcement",  // 必填，事件名称
  "data": { ... }           // 可选，消息数据
}
```

### 13.6 强制断开用户连接
- **接口**: `POST /api/websocket/user/:userId/disconnect`
- **认证**: 需要认证
- **权限**: `websocket:disconnect`
- **路径参数**: `userId` - 用户ID
- **请求参数**:
```json
{
  "reason": "管理员操作"  // 可选，断开原因
}
```

---

## 错误码说明

| 错误码 | 说明 |
|--------|------|
| 0 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未授权/Token无效 |
| 403 | 权限不足 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |
| 10001 | 用户名或密码错误 |
| 10002 | 用户已被禁用 |
| 10003 | Token已过期 |
| 10004 | 用户不存在 |
| 10005 | 用户名已存在 |

---

## 权限编码列表

| 模块 | 权限编码 | 说明 |
|------|----------|------|
| 用户 | user:list | 用户列表 |
| 用户 | user:detail | 用户详情 |
| 用户 | user:create | 创建用户 |
| 用户 | user:update | 更新用户 |
| 用户 | user:delete | 删除用户 |
| 角色 | role:list | 角色列表 |
| 角色 | role:detail | 角色详情 |
| 角色 | role:create | 创建角色 |
| 角色 | role:update | 更新角色 |
| 角色 | role:delete | 删除角色 |
| 角色 | role:assign | 分配权限 |
| 菜单 | menu:list | 菜单列表 |
| 菜单 | menu:detail | 菜单详情 |
| 菜单 | menu:create | 创建菜单 |
| 菜单 | menu:update | 更新菜单 |
| 菜单 | menu:delete | 删除菜单 |
| 权限 | permission:list | 权限列表 |
| 权限 | permission:detail | 权限详情 |
| 权限 | permission:create | 创建权限 |
| 权限 | permission:update | 更新权限 |
| 权限 | permission:delete | 删除权限 |
| 字典 | dict:list | 字典列表 |
| 字典 | dict:detail | 字典详情 |
| 字典 | dict:create | 创建字典 |
| 字典 | dict:update | 更新字典 |
| 字典 | dict:delete | 删除字典 |
| 机构 | org:list | 机构列表 |
| 机构 | org:detail | 机构详情 |
| 机构 | org:create | 创建机构 |
| 机构 | org:update | 更新机构 |
| 机构 | org:delete | 删除机构 |
| 职位 | position:list | 职位列表 |
| 职位 | position:detail | 职位详情 |
| 职位 | position:create | 创建职位 |
| 职位 | position:update | 更新职位 |
| 职位 | position:delete | 删除职位 |
| 日志 | log:list | 日志列表 |
| 日志 | log:export | 导出日志 |
| 任务 | job:list | 任务列表 |
| 任务 | job:start | 启动任务 |
| 任务 | job:stop | 停止任务 |
| 监控 | monitor:metrics | 监控指标 |
| 导出 | export:user | 导出用户 |
| 导出 | export:role | 导出角色 |
| 导入 | import:user | 导入用户 |
| 导入 | import:role | 导入角色 |
| WebSocket | websocket:list | 在线用户列表 |
| WebSocket | websocket:send | 发送消息 |
| WebSocket | websocket:broadcast | 广播消息 |
| WebSocket | websocket:disconnect | 断开连接 |

---

## 数据模型字段说明

### 用户表 (sys_user)
| 字段 | 类型 | 说明 | 新增 |
|------|------|------|------|
| id | int | 用户ID | - |
| username | varchar | 用户名 | - |
| password | varchar | 密码（加密） | - |
| nickname | varchar | 昵称 | ✓ |
| role_id | int | 角色ID | ✓ |
| status | tinyint | 状态（1-启用，0-禁用） | - |
| org_id | int | 机构ID | ✓ |
| position_id | int | 职位ID | ✓ |
| avatar | varchar | 头像URL | - |
| phone | varchar | 联系电话 | - |
| email | varchar | 邮箱 | - |
| gender | tinyint | 性别（0未知 1男 2女） | - |
| birthday | date | 出生年月 | ✓ |
| remark | text | 备注 | ✓ |
| last_login_ip | varchar | 最后登录IP | ✓ |
| last_login_time | datetime | 最后登录时间 | ✓ |
| create_time | datetime | 创建时间 | - |
| update_time | datetime | 更新时间 | - |

### 角色表 (sys_role)
| 字段 | 类型 | 说明 | 新增 |
|------|------|------|------|
| id | int | 角色ID | - |
| role_name | varchar | 角色名称 | - |
| role_code | varchar | 角色编码 | - |
| description | text | 角色描述 | - |
| status | tinyint | 状态（1-启用，0-禁用） | ✓ |
| sort | int | 排序 | ✓ |
| create_time | datetime | 创建时间 | - |
| update_time | datetime | 更新时间 | ✓ |

### 机构表 (sys_organization)
| 字段 | 类型 | 说明 | 新增 |
|------|------|------|------|
| id | int | 机构ID | - |
| org_name | varchar | 机构名称 | - |
| org_code | varchar | 机构编码 | - |
| parent_id | int | 父机构ID | - |
| sort | int | 排序 | - |
| status | tinyint | 状态（1-启用，0-禁用） | - |
| leader | varchar | 负责人 | ✓ |
| phone | varchar | 联系电话 | ✓ |
| email | varchar | 邮箱 | ✓ |
| remark | text | 备注 | ✓ |
| create_time | datetime | 创建时间 | - |
| update_time | datetime | 更新时间 | ✓ |

### 职位表 (sys_position)
| 字段 | 类型 | 说明 | 新增 |
|------|------|------|------|
| id | int | 职位ID | - |
| position_name | varchar | 职位名称 | - |
| position_code | varchar | 职位编码 | - |
| org_id | int | 所属机构ID | - |
| sort | int | 排序 | - |
| status | tinyint | 状态（1-启用，0-禁用） | - |
| remark | text | 备注 | ✓ |
| create_time | datetime | 创建时间 | - |
| update_time | datetime | 更新时间 | ✓ |

### 权限表 (sys_permission)
| 字段 | 类型 | 说明 | 新增 |
|------|------|------|------|
| id | int | 权限ID | - |
| perm_name | varchar | 权限名称 | ✓ |
| perm_code | varchar | 权限编码 | ✓ |
| perm_type | tinyint | 权限类型（1-菜单，2-按钮，3-接口） | ✓ |
| parent_id | int | 父权限ID | ✓ |
| path | varchar | 路由路径 | ✓ |
| component | varchar | 组件路径 | ✓ |
| icon | varchar | 图标 | ✓ |
| sort | int | 排序 | ✓ |
| visible | tinyint | 是否可见（1-是，0-否） | ✓ |
| remark | text | 备注 | ✓ |
| create_time | datetime | 创建时间 | - |
| update_time | datetime | 更新时间 | ✓ |

### 字典表 (sys_dict)
| 字段 | 类型 | 说明 | 新增 |
|------|------|------|------|
| id | int | 字典ID | - |
| dict_type | varchar | 字典类型 | - |
| dict_code | varchar | 字典编码 | - |
| dict_value | varchar | 字典值 | - |
| dict_label | varchar | 字典标签 | - |
| sort | int | 排序 | - |
| status | tinyint | 状态（1-启用，0-禁用） | - |
| create_time | datetime | 创建时间 | - |
| update_time | datetime | 更新时间 | ✓ |

### 操作日志表 (sys_operation_log)
| 字段 | 类型 | 说明 | 新增 |
|------|------|------|------|
| id | int | 日志ID | - |
| user_id | int | 用户ID | - |
| username | varchar | 用户名 | - |
| operation | varchar | 操作URL | - |
| method | varchar | 请求方法 | - |
| url | varchar | 请求URL | - |
| ip | varchar | IP地址 | - |
| params | text | 请求参数 | - |
| result | text | 操作结果 | - |
| duration | int | 耗时（毫秒） | - |
| user_agent | varchar | User-Agent信息 | ✓ |
| error_msg | text | 错误信息 | ✓ |
| status | tinyint | 状态（1-成功，0-失败） | ✓ |
| create_time | datetime | 创建时间 | - |

### 登录日志表 (sys_login_log)
| 字段 | 类型 | 说明 | 新增 |
|------|------|------|------|
| id | int | 日志ID | - |
| user_id | int | 用户ID | - |
| username | varchar | 用户名 | - |
| ip | varchar | 登录IP | - |
| location | varchar | 登录位置 | ✓ |
| browser | varchar | 浏览器信息 | ✓ |
| os | varchar | 操作系统信息 | ✓ |
| user_agent | varchar | User-Agent完整信息 | - |
| status | tinyint | 登录状态（0-失败，1-成功） | - |
| message | varchar | 登录消息/失败原因 | - |
| login_time | datetime | 登录时间 | - |

---

## 更新日志

### v2.0.0 (2024-12-25)
**新增字段**:
- 用户表：新增 `nickname`（昵称）、`remark`（备注）、`role_id`、`org_id`、`position_id`、`birthday`、`last_login_ip`、`last_login_time` 字段
- 角色表：新增 `status`（状态）、`sort`（排序）、`update_time` 字段
- 机构表：新增 `leader`（负责人）、`phone`（联系电话）、`email`（邮箱）、`remark`（备注）、`update_time` 字段
- 职位表：新增 `remark`（备注）、`update_time` 字段
- 权限表：新增 `perm_name`、`perm_code`、`perm_type`、`parent_id`、`path`、`component`、`icon`、`sort`、`visible`、`remark`、`update_time` 字段
- 字典表：新增 `update_time` 字段
- 操作日志表：新增 `user_agent`（User-Agent信息）、`error_msg`（错误信息）、`status`（状态） 字段
- 登录日志表：新增 `location`（登录位置）、`browser`（浏览器信息）、`os`（操作系统信息） 字段

**功能增强**:
- 所有创建和更新接口已支持新增字段
- 日志导出功能已包含新增字段
- Swagger API 文档已更新所有新字段说明
